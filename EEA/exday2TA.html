
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Exercises Day 2 TA &#8212; Open Ephys EEA Course Materials 0.0.0 documentation</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Amplifier with Voltage Divider" href="ampvoltagediv.html" />
    <link rel="prev" title="Exercises Day 1 TA" href="exday1TA.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../index.html">
<p class="title">Open Ephys EEA Course Materials</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="kitlist.html">
  NeuroKit Contents
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="eeadocsindex.html">
  EEA Course Documents
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="disclaimer_terms_conditions.html">
  Terms and Conditions
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="safety.html">
   Safety &amp; Good Practices
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="software_requirements.html">
   Software Requirements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="theoryday1.html">
   Theory Day 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="theoryday2.html">
   Theory Day 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="theoryday3.html">
   Theory Day 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="theoryday4.html">
   Theory Day 4
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="exday1.html">
   Exercises Day 1
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="sinewave.html">
     Sinewave
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="exday2.html">
   Exercises Day 2
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="exday3.html">
   Exercises Day 3
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="Firmata.html">
     Firmata
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="project.html">
   Project
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="exday1TA.html">
   Exercises Day 1 TA
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="sinewave.html">
     Sinewave
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="current reference internal" href="#">
   Exercises Day 2 TA
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="ampvoltagediv.html">
     Amplifier with Voltage Divider
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="soldiffamp.html">
     Differential Amplifier Solutions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="finaldiffamp.html">
     Final Differential Amplifier
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="exday3TA.html">
   Exercises Day 3 TA
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="Firmata.html">
     Firmata
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#impedance">
   Impedance
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#operational-amplifiers">
   Operational Amplifiers
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#build-voltage-rails">
     Build voltage rails
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#add-bypass-capacitors">
     Add bypass capacitors
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#build-long-wire-equivalent-circuit">
     Build ‘long wire’ equivalent circuit
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#replace-long-wire-with-headstage">
     Replace ‘long wire’ with ‘headstage’
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#differential-signals">
   Differential Signals
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#connect-reference-electrode">
     Connect reference electrode
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#provide-negative-feedback">
     Provide negative feedback
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#feed-back-only-50-of-signal">
     Feed back only 50% of signal
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#build-inverting-op-amp">
     Build inverting op-amp
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#replace-ground-with-dc-signal">
     Replace ground with DC signal
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#add-reference-input-to">
     Add reference input to ‘+’
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#final-differential-amplifier">
     Final Differential Amplifier
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ta-wrap-up">
   TA Wrap Up
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#acknowledgements">
   Acknowledgements
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#licensing">
   Licensing
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="exercises-day-2-ta">
<span id="refeday2ta"></span><h1>Exercises Day 2 TA<a class="headerlink" href="#exercises-day-2-ta" title="Permalink to this headline">¶</a></h1>
<div class="section" id="impedance">
<h2>Impedance<a class="headerlink" href="#impedance" title="Permalink to this headline">¶</a></h2>
<p>Previously, we built the circuit below using the circuit simulator. We saw that the electrode cannot drive a cable that has a shunt capacitance, but that an amplifier can protect our signal source and provide current to power the rest of the circuit.</p>
<a class="reference external image-reference" href="https://tinyurl.com/yf9jdf2b"><img alt="../_images/eea_fig-34.png" class="align-center" src="../_images/eea_fig-34.png" /></a>
<ol class="upperalpha simple">
<li><p>Open the simulator link. In the long wire configuration, swap out the 20pF and 100pF capacitor for a 1MOhm and 22kOhm resistor. What changes?</p></li>
</ol>
</div>
<div class="section" id="operational-amplifiers">
<h2>Operational Amplifiers<a class="headerlink" href="#operational-amplifiers" title="Permalink to this headline">¶</a></h2>
<p>Using an operational amplifier (op-amp) means we draw (almost) no current, which means we can measure voltages even if they come from things that can’t deliver current (like our cells).
Let’s build the above example from the simulator in real life, on the breadboard! We’ll treat the ‘Blink’ example as our neuronal data and see what happens to this signal if we just have a wire, and then see the effect of replacing this wire with an op-amp.</p>
<div class="section" id="build-voltage-rails">
<h3>Build voltage rails<a class="headerlink" href="#build-voltage-rails" title="Permalink to this headline">¶</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Make sure that the pins from the batteries do not touch, and if they’re not in use, best to put some tape on them so they don’t touch things. ‘Short-circuiting’ the batteries (connecting them without any sort of resistance) causes a huge current to flow from the + to -, enough to… melt stuff.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is way easier if you check that everyone has the blue line of the breadboard at the top, the battery holders on the right, and the teensy on the left from the start. Removing the teensy can bend the pins, if they put it all the way to the left, they can leave it there all week.</p>
</div>
<p>First, we need to make the ‘rails’ that will provide the voltage for our op-amp. - this means that we need to have a positive and negative voltage ready, so that we can amplify a signal that lives around some reference level that we shall call 0 volt. If we only have 0 and +3V then any negative signal will floor and stay at 0.</p>
<p>To do this we use a common trick and turn two regular power supplies into a bipolar power supply. In our case we use batteries, because they’re cheap and pretty much fully noise-free. One pair of batteries provides 3V relative to ground, 0V. Both ground rails are connected. The second pair of batteries is reversed to provide -3V relative to ground, so that we get a + and a – voltage.</p>
<img alt="../_images/eea_fig-35.png" class="align-center" src="../_images/eea_fig-35.png" />
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Check which way up your breadboard is (keep the blue line at the top). Following the figures precisely will make debugging much easier later on.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Remember or label which side is +3 and which is -3</p>
</div>
</div>
<div class="section" id="add-bypass-capacitors">
<h3>Add bypass capacitors<a class="headerlink" href="#add-bypass-capacitors" title="Permalink to this headline">¶</a></h3>
<p>Bypass capacitors are simply small capacitors that act like little secondary batteries. In our case we’ll add two 100nF (marked 104) caps, one to each rail, so GND to 3V and GND to -3V. The reason is that the batteries we use have what’s called a high ESR - ‘equivalent series resistance’ and some capacitance, so they are not great at quickly providing current. This means that when our op-amp starts doing stuff, it can run out of current for a very short time, until the battery can drive the rails back to their original voltage. This is bad for the signal quality and causes all kinds of issues. So, we give the rails the ability to very quickly provide a small amount of current from these small capacitors. We’re exploiting the fact that these caps have very low ESR and can provide current pretty much instantaneously. If the battery briefly can’t provide current, the bypass capacitors will discharge, providing quick back-up current. The fact that they’re too small to power anything for more than a millisecond does not matter here, at that point the batteries have caught up.</p>
<ol class="upperalpha simple">
<li><p>Add two 100nF (marked 104) caps, one to each rail, so connecting GND to 3V and connecting GND to -3V (see image below).</p></li>
</ol>
<img alt="../_images/eea_fig-36.png" class="align-center" src="../_images/eea_fig-36.png" />
</div>
<div class="section" id="build-long-wire-equivalent-circuit">
<h3>Build ‘long wire’ equivalent circuit<a class="headerlink" href="#build-long-wire-equivalent-circuit" title="Permalink to this headline">¶</a></h3>
<p>Now we will build the equivalent of having an electrode picking up a neuronal signal, and a long wire connecting this electrode to the recording system, without a headstage in between.
We’re going to build the circuit below (note the square wave input, just like the blink example). We’re using resistors to model our electrode and shunt voltage divider. For now, we don’t need the voltage rails, they will be used to power our amplifier later.</p>
<img alt="../_images/eea_fig-37.png" class="align-center" src="../_images/eea_fig-37.png" />
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the previous examples we had a shunt capacitance going to ground. Now, we have a going to ground, this is because of the slow frequency of the blink signal (remember slow freq = high capacitor impedance, so at the really slow blink frequency (0.5 Hz) we don’t actually lose a lot of voltage over the capacitance to ground). Our real, neuron signals are way faster, and then the shunt capacitance becomes a problem. To represent how long cables can cause us to lose signal, for this low frequency, we use a resistor to ground.</p>
</div>
<ol class="arabic simple">
<li><p>Upload the Blink example to your teensy (or just run it if still loaded).</p></li>
<li><p>Send the teensy output through a 1MOhm resistor. This makes it behave a bit like a biological signal coming from an electrode.</p></li>
<li><p>A 22kOhm resistor to ground simulates the signal lost to ground over a really long wire.</p></li>
<li><p>Add one ‘readout’ wire connected to ground (for your oscilloscope ground lead)</p></li>
<li><p>Connect a second readout wire so that you can measure the output voltage of your system.</p></li>
</ol>
<img alt="../_images/eea_fig-38.png" class="align-center" src="../_images/eea_fig-38.png" />
<img alt="../_images/eea_fig-39.png" class="align-center" src="../_images/eea_fig-39.png" />
<ol class="arabic simple" start="6">
<li><p>Now measure the output with the oscilloscope at the points marked by red arrows in the image below, and complete the first column of the table below:</p></li>
</ol>
<img alt="../_images/eea_fig-40.png" class="align-center" src="../_images/eea_fig-40.png" />
<table class="colwidths-given table">
<colgroup>
<col style="width: 40%" />
<col style="width: 30%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>(+) Probe Location</p></th>
<th class="head"><p>Signal Amplitude (Long Wire)</p></th>
<th class="head"><p>Signal Amplitude (Op-Amp)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li><p>Teensy Output Pin 13</p></li>
</ol>
</td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li><p>Leg of 1 mOhm Resistor</p></li>
</ol>
</td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li><p>Readout Wire</p></li>
</ol>
</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>How much signal is lost by this ‘recording system’?</p>
</div>
<div class="section" id="replace-long-wire-with-headstage">
<h3>Replace ‘long wire’ with ‘headstage’<a class="headerlink" href="#replace-long-wire-with-headstage" title="Permalink to this headline">¶</a></h3>
<p>Now we will keep almost everything the same, but we will replace our long wire with a ‘headstage’. We will use only the most basic part of the headstage, an operational amplifier.</p>
<p>This is the op-amp you have.  Make sure you’re looking at the op-amp (LM358P), not the instrumentation amp (AD622). The op-amp should say ‘LM358’ on it.</p>
<img alt="../_images/eea_fig-41.png" class="align-center" src="../_images/eea_fig-41.png" />
<ol class="arabic simple">
<li><p>Place the op-amp on your breadboard, with the semicircle cutout on the left.</p></li>
<li><p>Connect the +3 voltage rail to ‘Vcc+’ and the -3 voltage rail to ‘Vcc-‘</p></li>
<li><p>Put the electrode output wire into the + input of your op-amp, and the output of the op-amp into the ‘wire’ simulation circuit.</p></li>
<li><p>Feed the output of the op-amp, back into the – input.</p></li>
</ol>
<img alt="../_images/eea_fig-42.png" class="align-center" src="../_images/eea_fig-42.png" />
<img alt="../_images/eea_fig-43.png" class="align-center" src="../_images/eea_fig-43.png" />
<p>Now measure the same three points as before and complete this table:</p>
<blockquote>
<div><table class="colwidths-given table" id="id1">
<caption><span class="caption-text">Measuring Signal Amplitude</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 40%" />
<col style="width: 30%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>(+) Probe Location</p></th>
<th class="head"><p>Signal Amplitude (Long Wire)</p></th>
<th class="head"><p>Signal Amplitude (Op Amp)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ol class="arabic simple">
<li><p>Teensy Output Pin 13</p></li>
</ol>
</td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><ol class="arabic simple" start="2">
<li><p>Leg of 1 mOhm Resistor</p></li>
</ol>
</td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><ol class="arabic simple" start="3">
<li><p>Readout Wire</p></li>
</ol>
</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The wire now cannot destroy our signal, because even though we did not amplify it at all (we only have unity gain) we ‘buffered’ it. Now the op-amp can push as much current into the wire as is needed and your signal makes it through.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Adding in the amplifier ‘headstage’ should protect the signal both at the readout wire and the electrode resistor, going from mV range in the long wire configuration to V range with the headstage. Try asking whether people understand why it’s also higher at the electrode- if students find that strange it’s often because they’re thinking of the amplifier as actually increasing the signal (as in, introducing a gain) rather than realising that it is the high input impedance that is protecting our signal.</p>
</div>
</div>
</div>
<div class="section" id="differential-signals">
<h2>Differential Signals<a class="headerlink" href="#differential-signals" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
</div>
<ol class="upperalpha simple">
<li><p>Measure across your fingers with the oscilloscope 1x probe. How big is the amplitude of this signal? Compare this to the size of a spike, around 100 µV.  Could you see a spike on top of that noise?</p></li>
</ol>
<p>So far, we have only considered the signal coming into our recording electrode, relative to ground. We will now add a reference electrode in the simulator.</p>
<p>You can think of the small square waves as spikes you are trying to detect, and the sine wave (that both reference and your measurement electrode share) as background- maybe slow EEG signals or 50Hz noise, which is likely to be present at both electrodes.</p>
<p>Step-by-step, we are going to build our ‘goal’ circuit has the following properties:</p>
<ul class="simple">
<li><p>Input from the measurement electrode (spikes)</p></li>
<li><p>Input from the reference electrode (common noise)</p></li>
<li><p>Output: Reference subtracted from measurement, multiplied by gain</p></li>
<li><p>Does not draw current from cells</p></li>
</ul>
<a class="reference external image-reference" href="https://tinyurl.com/y5pw86ox"><img alt="../_images/eea_fig-44.png" class="align-center" src="../_images/eea_fig-44.png" /></a>
<div class="section" id="connect-reference-electrode">
<h3>Connect reference electrode<a class="headerlink" href="#connect-reference-electrode" title="Permalink to this headline">¶</a></h3>
<ol class="upperalpha simple">
<li><p>Connect the reference and spike signal directly to your simulated electrode circuit, and in turn to the op-amp in open-loop configuration. Connect the output of the amplifier to the PC. Run the simulation. What (in V) is the amplifier giving as output?</p></li>
</ol>
<a class="reference external image-reference" href="https://tinyurl.com/y5pw86ox"><img alt="../_images/eea_fig-45.png" class="align-center" src="../_images/eea_fig-45.png" /></a>
<p>We have successfully subtracted the reference signal (as the output displays square waves), and our input signal is protected (no current is being drawn), but the output is saturating. This is a consequence of the huge gain of the op-amp mentioned earlier. This means we can’t just use it as a differential amplifier- any tiny difference between the inverting and non-inverting inputs will get amplified so much that the output will saturate, and be equal to whatever voltage is powering the amplifier (in this case, + and - 15 V).</p>
<ul class="simple">
<li><p>Measurement electrode input (spikes) YES</p></li>
<li><p>Reference electrode input (common noise) YES</p></li>
<li><p>Output: Reference subtracted from measurement, multiplied by gain YES… but gain is too large!</p></li>
<li><p>Does not draw current from cells YES</p></li>
</ul>
</div>
<div class="section" id="provide-negative-feedback">
<h3>Provide negative feedback<a class="headerlink" href="#provide-negative-feedback" title="Permalink to this headline">¶</a></h3>
<p>We need to do something to prevent our amplifier from always hitting power-rail values. We can provide negative feedback to the amplifier by looping the output back and feeding it into one of the terminals. The amplifier is going to do the same thing as before; output the difference between + and - multiplied by its huge gain. The output will rise rapidly, however this time, as soon as it reaches the value of the + terminal, the + and – are the same value and there’s no difference left to amplify.</p>
<ol class="upperalpha simple" start="2">
<li><p>Put the reference signal to one side/ delete it for now. Connect the amplifier output to the inverting input. What happens to your output now? What is the gain?</p></li>
</ol>
<img alt="../_images/eea_fig-46.png" class="align-center" src="../_images/eea_fig-46.png" />
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Now we’re just seeing our input signal replicated at the output of the amplifier with a gain of 1.
<a class="reference external" href="https://tinyurl.com/y6tkhc79">circuit link</a></p>
</div>
<ul class="simple">
<li><p>Measurement electrode input (spikes) YES</p></li>
<li><p>Reference electrode input (common noise) NO</p></li>
<li><p>Output: Reference subtracted from measurement, multiplied by gain NO</p></li>
<li><p>Does not draw current from cells YES</p></li>
</ul>
<p>We’ve stopped it saturating, but we still can’t amplify, or subtract our reference electrode.</p>
</div>
<div class="section" id="feed-back-only-50-of-signal">
<h3>Feed back only 50% of signal<a class="headerlink" href="#feed-back-only-50-of-signal" title="Permalink to this headline">¶</a></h3>
<p>Let’s start with amplifying.</p>
<p>If we only feed back 50% of the output voltage, the amplifier will again detect a difference between the + and - terminals, and will increase (double) its output voltage until - and + are equal once more. We can vary the proportion of the output voltage that we feed back, in order to adjust the gain of our amplifier. To do so, we need to divide the voltage into the part we want to send to the amplifier, and the part we want to get rid of, which we can route to ground.</p>
<ol class="upperalpha simple" start="3">
<li><p>Add resistors to your simulated circuit to build an amplifier with a gain of 2, using what you learned about voltage dividers on day 1. The answer is here: <a class="reference internal" href="ampvoltagediv.html#ampvoltagediv"><span class="std std-ref">Amplifier with Voltage Divider</span></a>, but try it on your own first.</p></li>
</ol>
<p>Now we have a. protected our signal and b. amplified it!</p>
<ul class="simple">
<li><p>Measurement electrode input (spikes) YES</p></li>
<li><p>Reference electrode input (common noise) NO</p></li>
<li><p>Output: Reference subtracted from measurement, multiplied by gain NO.. but we have a reasonable gain now.</p></li>
<li><p>Does not draw current from cells YES</p></li>
</ul>
<p>We want to introduce our reference again. How can we do that, and keep all those other properties we worked so hard for?</p>
</div>
<div class="section" id="build-inverting-op-amp">
<h3>Build inverting op-amp<a class="headerlink" href="#build-inverting-op-amp" title="Permalink to this headline">¶</a></h3>
<p>Both the input and the feedback need to share the ‘-’ input, so that the amplifier doesn’t saturate. First, we will build an inverting op-amp, by putting the ‘-’ input in the middle of a voltage divider, with the feedback on one side, and the input on the other. We connect ‘+’ to ground. Now the op-amp will output whatever voltage is needed to keep the ‘-’ at ground level, i.e. 0 V (because we connect ‘+’ to ground, if we had another voltage at ground it would keep ‘-’ at that voltage).</p>
<p>What voltage does the amplifier have to output to keep ‘-‘ at 0V?</p>
<div class="math notranslate nohighlight">
\[Vout = -1 * Vin\]</div>
<p>i.e. the amplifier has to provide directly opposing voltage to whatever comes in at the input.</p>
<p>The cool but confusing bit here is that the ‘-’ input is always at 0V, which is why we call it ‘virtual ground’. This circuit works due to the fact that current still flows through the circuit (but never into the amplifier!), even though the voltage of the node is kept at 0.</p>
<ol class="upperalpha simple" start="4">
<li><p>Build this inverting op amp. Check in the simulator that this virtual ground really works. If this is still mysterious, watch the section in this video (here: <a class="reference external" href="https://youtu.be/7FYHt5XviKc?t=933">https://youtu.be/7FYHt5XviKc?t=933</a> ).</p></li>
</ol>
</div>
<div class="section" id="replace-ground-with-dc-signal">
<h3>Replace ground with DC signal<a class="headerlink" href="#replace-ground-with-dc-signal" title="Permalink to this headline">¶</a></h3>
<p>Ok now we have the inverting amplifier, what good is that? Well, we have freed up the ‘+’ input and  can now replace the ground at the ‘+’ input with something else.</p>
<ol class="upperalpha simple" start="5">
<li><p>Add a constant +2.5 V to the input. What happens to the output?</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It should be shifted upwards, replacing the virtual ground of 0 with +2.5</p>
</div>
<p>Because the initial input was already inverted, by adding to that we have now effectively subtracted one voltage from another. We are close to having what we want, we just need to replace the stable offset voltage at ‘+’ with the 2nd signal we wish to subtract (our reference).</p>
</div>
<div class="section" id="add-reference-input-to">
<h3>Add reference input to ‘+’<a class="headerlink" href="#add-reference-input-to" title="Permalink to this headline">¶</a></h3>
<ol class="upperalpha simple" start="6">
<li><p>Replace the +2.5 signal with your reference electrode.</p></li>
</ol>
<p>Does this work? What went wrong?
Try to figure this out but don’t get stuck forever.</p>
<p>Solution here: <a class="reference internal" href="soldiffamp.html#soldiffamp"><span class="std std-ref">Differential Amplifier Solutions</span></a>.</p>
<ul class="simple">
<li><p>Measurement electrode input (spikes) YES</p></li>
<li><p>Reference electrode input (common noise) YES</p></li>
<li><p>Output: Reference subtracted from measurement, multiplied by gain NO</p></li>
<li><p>Does not draw current from cells YES</p></li>
</ul>
</div>
<div class="section" id="final-differential-amplifier">
<h3>Final Differential Amplifier<a class="headerlink" href="#final-differential-amplifier" title="Permalink to this headline">¶</a></h3>
<p>Now we’re pretty much there! The only thing left is that right now our amp outputs the difference between our measurement and reference, but inverted. So just swap the inputs and we’re there!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The reference coming into the - means that the amplifier no longer has to provide this output in order to make the + and – match, so we get rid of the shared signal.
Need to look at difference: want: <a class="reference external" href="https://tinyurl.com/y4aps4r2">https://tinyurl.com/y4aps4r2</a></p>
</div>
<ol class="upperalpha simple" start="7">
<li><p>In the simulator, re-create a differential amplifier.</p></li>
</ol>
<p>Solution here: <a class="reference internal" href="finaldiffamp.html#finaldiffamp"><span class="std std-ref">Final Differential Amplifier</span></a>.</p>
<blockquote>
<div><ul class="simple">
<li><p>Measurement electrode input (spikes) YES</p></li>
<li><p>Reference electrode input (common noise) YES</p></li>
<li><p>Output: Reference subtracted from measurement, multiplied by gain YES</p></li>
<li><p>Does not draw current from cells YES</p></li>
</ul>
</div></blockquote>
<ol class="upperalpha simple" start="8">
<li><p>If you have this circuit working, start changing the 10M resistor on the top to another value and see what happens.</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>Change it to 11M or so. This is very roughly what a normal op-amp would look like. We’re getting some noise but it’s not horrible yet.</p></li>
<li><p>Now bump up the common mode noise a bit. Change the voltage on both 60Hz sources from 5V to 50V. What happens?</p></li>
</ul>
</div></blockquote>
<p>So, can we use this shiny new differential amplifier to record neural signals? We worked so hard to avoid drawing current from our frail electrode signal, and now we’re telling you to put big voltage dividers right at the inputs of our op-amp? That seems bad. Also, as we’ve just simulated, often op-amps do not have equal input impedances across + and -! This is similar to the example form earlier where we modelled a long wire, except that now you have two wires of different lengths in front of your inputs. If you’ve every measured electrode impedance, how much variation was there between electrodes? To get this differential amplifier to work, each electrode and resistor would have to be identical, which is, in practice, impossible.</p>
<p>Puzzle for extra credit: How can we preserve the nice differential properties of the amplifier we just built, but still have our signals go straight into like a ‘+’ terminal on an op-amp to avoid impedance imbalances, and to avoid drawing current through voltage dividers? Extra hint: op-amps are cheap.</p>
</div>
</div>
<div class="section" id="ta-wrap-up">
<h2>TA Wrap Up<a class="headerlink" href="#ta-wrap-up" title="Permalink to this headline">¶</a></h2>
<p>Solution: ‘buffer’ the inputs individually before they are subtracted, and then the differences in input impedances don’t matter! This is building an ‘instrumentation amplifier’ out of 3 op-amps:</p>
<a class="reference external image-reference" href="https://tinyurl.com/yjxekrv5"><img alt="../_images/eea_fig-53.png" class="align-center" src="../_images/eea_fig-53.png" /></a>
<p>So far: we know how to protect our signal and amplify it. Tomorrow we’ll look at getting signals from our electrodes, filtering them, and sending them to our computer.</p>
</div>
<div class="section" id="acknowledgements">
<h2>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permalink to this headline">¶</a></h2>
<p>Written by:</p>
<ul class="simple">
<li><p>Alexandra Leighton</p></li>
<li><p>Joana Neto</p></li>
<li><p>Jakob Voigts</p></li>
<li><p>Aarón Cuevas López</p></li>
<li><p>Jon Newman</p></li>
</ul>
<p>With material from:</p>
<ul class="simple">
<li><p>Joana Neto, 2018; Materials and neuroscience: validating tools for large-scale, high-density neural recording, 2018</p></li>
<li><p>Jon Newman and Jakob Voigts, 2017; Intro to Chronic Ephys (presentation at TENSS)</p></li>
<li><p>Mitra Javadzadeh, 2017; Building an analog ephys recording system (practical exercises developed for TENSS)</p></li>
<li><p>Circuit Simulator version 2.4.6js. Original by Paul Falstad, JavaScript conversion by Iain Sharp</p></li>
</ul>
</div>
<div class="section" id="licensing">
<h2>Licensing<a class="headerlink" href="#licensing" title="Permalink to this headline">¶</a></h2>
<p>This work is licensed under CC BY-SA 4.0.</p>
<p>To view a copy of this license, visit <a class="reference external" href="https://creativecommons.org/licenses/by-sa/4.0/">https://creativecommons.org/licenses/by-sa/4.0/</a></p>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="exday1TA.html" title="previous page">Exercises Day 1 TA</a>
    <a class='right-next' id="next-link" href="ampvoltagediv.html" title="next page">Amplifier with Voltage Divider</a>

              </div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2010-2021, Open Ephys, OEPS &amp; Contributors.<br/>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.0.3.<br/>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>